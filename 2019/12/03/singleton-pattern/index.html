<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><meta name="keywords" content="个人博客, Java, Spring, 后端开发, 程序员"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.4"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.4"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" type="text/css" href="https://unpkg.com/gitalk/dist/gitalk.css?v=2.0.4"><title>单例模式 | 纵有千山</title><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">单例模式</h1><a id="logo" href="/.">纵有千山</a><p class="description">一个人只拥有此生此世是不够的，他还应该拥有诗意的世界</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">单例模式</h1><div class="post-meta"><a href="/2019/12/03/singleton-pattern/#comments" class="comment-count"></a><p><span class="date">Dec 03, 2019</span><span><a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="category">设计模式</a></span></p></div><div class="post-content"><p>单例模式的定义是一个类有且仅有一个实例，并且自行实例化向整个系统提供。</p>
<p>其实现要点为：</p>
<ol>
<li>私有的构造函数（保证只能由自身实例化自身）</li>
<li>提供一个方法返回自身的唯一实例</li>
</ol>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>单例模式常见的几种实现方式。</p>
<h2 id="线程不安全懒汉式"><a href="#线程不安全懒汉式" class="headerlink" title="线程不安全懒汉式"></a>线程不安全懒汉式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton1 instance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton1 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> Singleton1();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于<code>getInstance()</code>方法没有加锁，在多线程中会出现多个线程都命中判断条件<code>instance == null</code>，导致new多个实例对象。</p>
<h2 id="线程安全懒汉式"><a href="#线程安全懒汉式" class="headerlink" title="线程安全懒汉式"></a>线程安全懒汉式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton2 instance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> Singleton2 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> Singleton2();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>getInstance()</code>方法上加锁，静态方法上加锁锁住的是类对象，虽然保证了线程安全，但是获取实例的方法加锁导致获取实例开销大、效率低。</p>
<h2 id="线程安全饿汉式"><a href="#线程安全饿汉式" class="headerlink" title="线程安全饿汉式"></a>线程安全饿汉式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton3 instance = <span class="keyword">new</span> Singleton3();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton3 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于类加载机制保证了线程安全（虚拟机保证在多线程同时初始化一个类的情况下， 只有会一个线程执行这个类的<code>&lt;clinit&gt;()</code>方法，其他线程需要阻塞等待。）</p>
<h2 id="双检锁机制"><a href="#双检锁机制" class="headerlink" title="双检锁机制"></a>双检锁机制</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton4 instance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton4 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton4<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> Singleton4();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先判断是否为空，再加锁。再实例化完成后，获取单例对象是无锁的，与线程安全的懒汉式实现相比，提高了获取单例对象的效率。</p>
<p>使用<code>volatile</code>关键字禁止指令重排，防止空指针异常：</p>
<p><code>@code instance = new Singleton4()</code>这一行代码实际上是由三步操作（多条指令。线程切换可能发生在任意指令之后）完成：</p>
<ol>
<li>分配内存空间</li>
<li>初始化对象</li>
<li><code>instance</code>指向内存空间</li>
</ol>
<p>如果未加<code>volatile</code>关键字，则可能发生指令重排序，执行步骤可能为 1-&gt;3-&gt;2。那么<code>instance == null</code>这个条件判断对象是否初始化时，因为步骤 3已经完成，但是实际上仍然在进行步骤 2，导致空指针异常。<strong>但是自己写并发代码测试时，未加<code>volatile</code>关键字也没出现过空指针异常。</strong>测试过多次且改了多次测试代码也没有出现过空指针异常问题，这点原因暂时未知。测试代码可能有些问题，结论未知。</p>
<h2 id="静态内部类"><a href="#静态内部类" class="headerlink" title="静态内部类"></a>静态内部类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton5</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Singleton5 instance = <span class="keyword">new</span> Singleton5();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton5 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用内部静态类来实现懒加载，且线程安全，写法简单。</p>
<h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Singleton6 &#123;</span><br><span class="line"></span><br><span class="line">    INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>枚举实现单例是实现单例的最佳方式，可以绝对防止多次实例化。</p>
<p>而单例模式在Spring中应用，IoC容器使用的是登记式实现单例（单例注册表），不属于上面介绍的几种方式。</p>
<h1 id="破坏"><a href="#破坏" class="headerlink" title="破坏"></a>破坏</h1><p>单例模式的破坏与防止破坏。</p>
<h2 id="序列化破坏"><a href="#序列化破坏" class="headerlink" title="序列化破坏"></a>序列化破坏</h2><p>序列化场景下的破坏，但是个人其实没有见过将单例对象进行序列化传输的应用场景。</p>
<h3 id="序列化破坏验证"><a href="#序列化破坏验证" class="headerlink" title="序列化破坏验证"></a>序列化破坏验证</h3><p>实现<code>Serializable</code>接口的单例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializeSingleton</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2896782629930400984L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> SerializeSingleton instance = <span class="keyword">new</span> SerializeSingleton();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SerializeSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SerializeSingleton.SingletonHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SerializeSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    SerializeSingleton singleton = SerializeSingleton.getInstance();</span><br><span class="line">    <span class="keyword">byte</span>[] serializeByte;</span><br><span class="line">    <span class="comment">// 序列化为 byte数组</span></span><br><span class="line">    <span class="keyword">try</span> (ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">         ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream)) &#123;</span><br><span class="line">        out.writeObject(singleton);</span><br><span class="line">        serializeByte = byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">    SerializeSingleton serializeSingleton;</span><br><span class="line">    <span class="comment">// 通过 byte数组反序列化</span></span><br><span class="line">    <span class="keyword">try</span> (ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(serializeByte);</span><br><span class="line">         ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(byteArrayInputStream)) &#123;</span><br><span class="line">        serializeSingleton = (SerializeSingleton) in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(singleton);</span><br><span class="line">    System.out.println(serializeSingleton);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.chensiqu.patterns.singleton.serialize.SerializeSingleton@58372a00</span><br><span class="line">org.chensiqu.patterns.singleton.serialize.SerializeSingleton@25f38edc</span><br></pre></td></tr></table></figure>

<p>可以看出得到了不同的两个实例对象。实现<code>Serializable</code>接口的单例类没有经过特殊处理的话，导致单例模式被破坏。本质上也是由反射操作导致的单例模式被破坏。</p>
<h3 id="序列化破坏防止"><a href="#序列化破坏防止" class="headerlink" title="序列化破坏防止"></a>序列化破坏防止</h3><p>可以增加<code>readResolve()</code>方法进行解决：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializeSingleton</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2896782629930400984L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> SerializeSingleton instance = <span class="keyword">new</span> SerializeSingleton();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SerializeSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SerializeSingleton.SingletonHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SerializeSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用破坏验证的测试代码重新测试，结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.chensiqu.patterns.singleton.serialize.SerializeSingleton@58372a00</span><br><span class="line">org.chensiqu.patterns.singleton.serialize.SerializeSingleton@58372a00</span><br></pre></td></tr></table></figure>

<p>可以发现反序列化得到的实例对象与原先的实例对象是同一个对象。</p>
<p>源码分析：</p>
<p>在类<code>ObjectInputStream</code>的<code>readOrdinaryObject()</code>方法中，</p>
<p><img src="image-20191206153712049.png" alt="image-20191206153712049"></p>
<p>在使用<code>readObject()</code>反序列化时，会判断该类是否存在<code>readResolve()</code>方法，存在则调用此方法返回此方法返回的实例对象。</p>
<p>可以进行测试，将<code>readObject()</code>返回对象改为一个字符串：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"test"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将测试代码的反序列化结果类型修改为<code>Object</code>，得到的结果为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.chensiqu.patterns.singleton.serialize.SerializeSingleton@<span class="number">58372</span>a00</span><br><span class="line">test</span><br></pre></td></tr></table></figure>

<h2 id="反射破坏"><a href="#反射破坏" class="headerlink" title="反射破坏"></a>反射破坏</h2><p>通过反射调用私有的构造器，从而实例化一个新的对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException </span>&#123;</span><br><span class="line">    Singleton singleton = Singleton.getInstance();</span><br><span class="line">    Class&lt;Singleton&gt; clazz = Singleton<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">    Constructor&lt;Singleton&gt; constructor = clazz.getDeclaredConstructor();</span><br><span class="line">    <span class="keyword">if</span> (!constructor.isAccessible()) &#123;</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Singleton reflectionSingleton = constructor.newInstance();</span><br><span class="line">    System.out.println(singleton);</span><br><span class="line">    System.out.println(reflectionSingleton);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.chensiqu.patterns.singleton.damage.Singleton@214c265e</span><br><span class="line">org.chensiqu.patterns.singleton.damage.Singleton@448139f0</span><br></pre></td></tr></table></figure>

<p>反射这种人为的破坏单例模式的方式，要想防范的话可以使用枚举实现单例。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.NoSuchMethodException: org.chensiqu.patterns.singleton.Singleton6.&lt;init&gt;()</span><br><span class="line">	at java.lang.Class.getConstructor0(Class.java:3082)</span><br><span class="line">	at java.lang.Class.getDeclaredConstructor(Class.java:2178)</span><br><span class="line">	at org.chensiqu.patterns.singleton.damage.ReflectionTest.main(ReflectionTest.java:18)</span><br></pre></td></tr></table></figure>

<p>关于枚举实现单例防止反射破坏的更多细节，可以查看这篇博文：</p>
<p><a href="https://www.cnblogs.com/chiclee/p/9097772.html" target="_blank" rel="noopener">为什么要用枚举实现单例模式</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.runoob.com/design-pattern/singleton-pattern.html" target="_blank" rel="noopener">单例模式 | 菜鸟教程</a></p>
</div><div class="post-copyright"><blockquote><p>原文作者: chensiqu</p><p>原文链接: <a href="http://www.csiqu.club/2019/12/03/singleton-pattern/">http://www.csiqu.club/2019/12/03/singleton-pattern/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2020/01/02/dubbo-asyn-sync/" class="pre">Dubbo异步转同步分析</a><a href="/2019/11/25/xml-mixed-content-deserialization/" class="next">XML混合内容反序列化（JAXB）</a></div><div id="comments"><div id="container"><script type="text/javascript" src="https://unpkg.com/gitalk/dist/gitalk.min.js?v=2.0.4"></script><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=2.0.4"></script><script>var gitalk = new Gitalk({
  clientID: '6ad4a49d58d5ae28fd30',
  clientSecret: '5428028452c90cc4b45c91095fbfd881bfd81fef',
  repo: 'discord010.github.io',
  owner: 'DIscord010',
  admin: ['DIscord010'],
  id: md5(window.location.pathname),
  distractionFreeMode: false,
  language: 'zh-CN',
  pagerDirection: 'last'
})
gitalk.render('container')</script></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#实现"><span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#线程不安全懒汉式"><span class="toc-text">线程不安全懒汉式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#线程安全懒汉式"><span class="toc-text">线程安全懒汉式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#线程安全饿汉式"><span class="toc-text">线程安全饿汉式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#双检锁机制"><span class="toc-text">双检锁机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#静态内部类"><span class="toc-text">静态内部类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#枚举"><span class="toc-text">枚举</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#破坏"><span class="toc-text">破坏</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#序列化破坏"><span class="toc-text">序列化破坏</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#序列化破坏验证"><span class="toc-text">序列化破坏验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#序列化破坏防止"><span class="toc-text">序列化破坏防止</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#反射破坏"><span class="toc-text">反射破坏</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/02/10/docker-mysql-exit/">Docker MySQL Exit(1)解决记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/02/dubbo-asyn-sync/">Dubbo异步转同步分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/03/singleton-pattern/">单例模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/25/xml-mixed-content-deserialization/">XML混合内容反序列化（JAXB）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/14/mysql-rr/">MySQL幻读分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/13/mybatis-dynamic-proxy/">Mybatis动态代理分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/30/shell-jar-execute/">Shell脚本执行JAR</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/24/springboot-shiro-think/">SpringBoot整合Shiro时的思考</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/24/cas-5-3-x/">CAS 5.3.x 服务端搭建小结</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/" style="font-size: 15px;">单点登录</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Mybatis/" style="font-size: 15px;">Mybatis</a> <a href="/tags/Dubbo/" style="font-size: 15px;">Dubbo</a> <a href="/tags/%E5%B9%BB%E8%AF%BB/" style="font-size: 15px;">幻读</a> <a href="/tags/Shell/" style="font-size: 15px;">Shell</a> <a href="/tags/%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 15px;">序列化</a> <a href="/tags/Shiro/" style="font-size: 15px;">Shiro</a> <a href="/tags/SpringBoot/" style="font-size: 15px;">SpringBoot</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 15px;">设计模式</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">7</span></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/about/">联系博主</a></p><p><span> Copyright &copy;<a href="/." rel="nofollow">chensiqu.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script type="text/javascript" src="/js/search.json.js?v=2.0.4"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.4" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":80},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>